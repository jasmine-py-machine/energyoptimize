
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Optimization in Job Shops</title>
    <script src="https://cdn.tailwindcss.com"></script>
      <script src="{{ url_for('static', filename='tailwin.js') }}"></script>
  <script src="{{ url_for('static', filename='R.JS') }}"></script>
  <script src="{{ url_for('static', filename='cloudfare.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart.js' ) }}"></script>
    <script src="{{ url_for('static', filename='js/html2canvas.min.js' ) }}"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .invalid { border-color: #ef4444 !important; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-container { max-width: 100%; overflow-x: auto; }
        #pie-chart, #bar-chart, #line-graph { max-height: 150px; max-width: 100%; }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen dark:bg-gray-800 transition-colors duration-300">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Energy Optimization Dashboard</h1>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white">
                <svg id="sun-icon" class="w-6 h-6 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="moon-icon" class="w-6 h-6 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in">
                <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Machines</h2>
                <div id="machine-list" class="mb-4 max-h-40 overflow-y-auto"></div>
                <div class="space-y-3">
                    <input id="machine-name" type="text" placeholder="Machine Name (Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <input id="machine-power" type="number" placeholder="Power (KW, Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" step="0.1" required>
                    <input id="machine-time" type="number" placeholder="Forecast Hours (Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <input id="machine-cost" type="number" placeholder="Cost per KWH (Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" step="0.01" required>
                    <button onclick="addMachine()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Add Machine</button>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in">
                <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Jobs</h2>
                <div id="job-list" class="mb-4 max-h-40 overflow-y-auto"></div>
                <div class="space-y-3">
                    <div class="relative">
                        <input id="job-name" type="text" placeholder="Job Name (Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                        <ul id="job-suggestions" class="border bg-white max-h-40 overflow-y-auto rounded shadow hidden absolute z-10 w-full"></ul>
                    </div>
                    <input id="job-time" type="number" placeholder="Processing Time (hrs, Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <input id="job-area" type="number" placeholder="Area (m², Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <input id="job-deadline" type="number" placeholder="Leadtime (hrs, Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <button onclick="addJob()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Add Job</button>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in">
                <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Work Station</h2>
                <div id="center-list" class="mb-4 max-h-40 overflow-y-auto"></div>
                <div class="space-y-3">
                    <input id="center-id" type="text" placeholder="Center ID (Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <input id="center-area" type="number" placeholder="Area (m², Required)" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                    <button onclick="addCenter()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Add Work Station</button>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Global Parameters</h2>
            <div id="global-parameters" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label class="block mb-2 text-gray-700 dark:text-gray-200">Total Shop Floor Area (m²)</label>
                    <input id="total-space" type="number" placeholder="Required" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                </div>
                <div>
                    <label class="block mb-2 text-gray-700 dark:text-gray-200">Total Energy (KWH)</label>
                    <input id="total-energy" type="number" placeholder="Required" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                </div>
                <div>
                    <label class="block mb-2 text-gray-700 dark:text-gray-200">Period Hours</label>
                    <input id="period-hours" type="number" placeholder="Required" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:text-white dark:border-gray-500" required>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="submit-btn" onclick="submitOptimization()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                <span id="submit-text">Run Optimization</span>
                <span id="loading-spinner" class="loading-spinner hidden ml-2"></span>
            </button>
            <button onclick="resetAll()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">Reset All</button>
            <button id="download-pdf-btn" onclick="downloadPDF()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Download PDF</button>
        </div>

        <div id="results-section" class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Optimization Results</h2>
            <pre id="optimization-result" class="bg-gray-100 dark:bg-gray-600 p-4 rounded text-sm text-gray-800 dark:text-gray-200"></pre>
            <h3 class="text-lg font-semibold mt-4 text-gray-900 dark:text-white">Energy Metrics by Activity Center</h3>
            <div id="center-energy-results" class="bg-gray-100 dark:bg-gray-600 p-4 rounded text-sm text-gray-800 dark:text-gray-200"></div>
            <div id="download-links" class="mt-4 flex flex-col sm:flex-row gap-2">
                <a id="download-excel" href="#" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors hidden">Download Excel</a>
                <a id="download-pdf" href="#" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors hidden">Download PDF File</a>
                <button onclick="alert('View Excel functionality requires local file access. Please download and open the Excel file.')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors hidden">View Excel</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in chart-container">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Cost Distribution (Pie Chart)</h3>
                <canvas id="pie-chart" class="w-full"></canvas>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in chart-container">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Energy Costs (Bar Chart)</h3>
                <canvas id="bar-chart" class="w-full"></canvas>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-700 p-4 sm:p-6 rounded-lg shadow card fade-in mt-4 chart-container">
            <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Energy Metrics (Line Graph)</h3>
            <canvas id="line-graph" class="w-full"></canvas>
        </div>
    </div>

    <script>
        let machines = [];
        let jobs = [];
        let centers = [];
        let jobTemplates = [];
        let latestOptimizationData = null;

        const html = document.documentElement;
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            sunIcon.classList.toggle('hidden');
            moonIcon.classList.toggle('hidden');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
            updateChartColors();
        });
        if (localStorage.getItem('theme') === 'dark') {
            html.classList.add('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        }

        function validateInput(input, condition, errorMessage) {
            if (!condition(input.value)) {
                input.classList.add('invalid');
                input.setCustomValidity(errorMessage);
            } else {
                input.classList.remove('invalid');
                input.setCustomValidity('');
            }
        }

        ['machine-name', 'machine-power', 'machine-time', 'machine-cost', 'job-name', 'job-time', 'job-area', 'job-deadline', 'center-id', 'center-area', 'total-space', 'total-energy', 'period-hours'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
                if (id.includes('name') || id.includes('id')) {
                    validateInput(input, val => val.trim().length > 0, 'This field is required.');
                } else {
                    validateInput(input, val => parseFloat(val) >= (id === 'job-area' || id === 'job-deadline' ? 0 : 0.1), `Enter a ${id === 'job-area' || id === 'job-deadline' ? 'non-negative' : 'positive'} number.`);
                }
            });
        });

        function addMachine() {
            const name = document.getElementById('machine-name').value.trim();
            const power = parseFloat(document.getElementById('machine-power').value);
            const time = parseFloat(document.getElementById('machine-time').value);
            const cost = parseFloat(document.getElementById('machine-cost').value);
            if (name && power > 0 && time > 0 && cost >= 0) {
                machines.push({id: `M${machines.length + 1}`, name, power, processing_time: time, cost});
                updateMachineList();
                clearInputs(['machine-name', 'machine-power', 'machine-time', 'machine-cost']);
            } else {
                alert('Please fill in all machine fields with valid values (positive numbers for power, time, and cost).');
            }
        }

        function addJob() {
            const name = document.getElementById('job-name').value.trim();
            const time = parseFloat(document.getElementById('job-time').value);
            const area = parseFloat(document.getElementById('job-area').value);
            const deadline = parseFloat(document.getElementById('job-deadline').value);
            if (name && time > 0 && area >= 0 && deadline >= 0) {
                jobs.push({id: `J${jobs.length + 1}`, name, processing_time: time, area, deadline});
                updateJobList();
                clearInputs(['job-name', 'job-time', 'job-area', 'job-deadline']);
            } else {
                alert('Please fill in all job fields with valid values (positive numbers for time, non-negative for area and deadline).');
            }
        }

        function addCenter() {
            const id = document.getElementById('center-id').value.trim();
            const area = parseFloat(document.getElementById('center-area').value);
            if (id && area > 0) {
                centers.push({id, area});
                updateCenterList();
                clearInputs(['center-id', 'center-area']);
            } else {
                alert('Please fill in all center fields with valid values (positive area).');
            }
        }

        function clearInputs(ids) {
            ids.forEach(id => {
                const input = document.getElementById(id);
                input.value = '';
                input.classList.remove('invalid');
                input.setCustomValidity('');
            });
        }

        function deleteMachine(index) {
            machines.splice(index, 1);
            machines = machines.map((m, i) => ({...m, id: `M${i + 1}`}));
            updateMachineList();
        }

        function deleteJob(index) {
            jobs.splice(index, 1);
            jobs = jobs.map((j, i) => ({...j, id: `J${i + 1}`}));
            updateJobList();
        }

        function deleteCenter(index) {
            centers.splice(index, 1);
            updateCenterList();
        }

        function updateMachineList() {
            const list = document.getElementById('machine-list');
            list.innerHTML = machines.map((m, i) => `
                <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded mb-2">
                    <span>${m.name}: Power=${m.power} KW, Time=${m.processing_time} hrs, Cost=${m.cost}</span>
                    <button onclick="deleteMachine(${i})" class="text-red-500 hover:text-red-700">Delete</button>
                </div>
            `).join('');
        }

        function updateJobList() {
            const list = document.getElementById('job-list');
            list.innerHTML = jobs.map((j, i) => `
                <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded mb-2">
                    <span>${j.name}: Time=${j.processing_time} hrs, Area=${j.area} m², Deadline=${j.deadline} hrs</span>
                    <button onclick="deleteJob(${i})" class="text-red-500 hover:text-red-700">Delete</button>
                </div>
            `).join('');
        }

        function updateCenterList() {
            const list = document.getElementById('center-list');
            list.innerHTML = centers.map((c, i) => `
                <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded mb-2">
                    <span>${c.id}: Area=${c.area} m²</span>
                    <button onclick="deleteCenter(${i})" class="text-red-500 hover:text-red-700">Delete</button>
                </div>
            `).join('');
        }

        async function submitOptimization() {
            const totalSpace = parseFloat(document.getElementById('total-space').value);
            const totalEnergy = parseFloat(document.getElementById('total-energy').value);
            const periodHours = parseFloat(document.getElementById('period-hours').value);
            if (machines.length === 0 || jobs.length === 0 || centers.length === 0 ||
                isNaN(totalSpace) || totalSpace <= 0 ||
                isNaN(totalEnergy) || totalEnergy <= 0 ||
                isNaN(periodHours) || periodHours <= 0) {
                alert('Please add at least one machine, job, and activity center, and fill in all required fields with positive values.');
                return;
            }
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const spinner = document.getElementById('loading-spinner');
            submitBtn.disabled = true;
            submitText.textContent = 'Optimizing...';
            spinner.classList.remove('hidden');
            try {
                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        machines,
                        jobs,
                        total_space: totalSpace,
                        total_energy: totalEnergy,
                        period_hours: periodHours,
                        activity_centers: Object.fromEntries(centers.map(c => [c.id, c.area]))
                    })
                });
                if (!response.ok) throw new Error('Optimization failed: ' + response.statusText);
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                latestOptimizationData = data;
                document.getElementById('optimization-result').textContent = data.optimization_result;
                const centerResults = document.getElementById('center-energy-results');
                centerResults.innerHTML = data.center_energy_results.map(r => 
                    `<p>Center ${r.center_id}, Machine ${r.machine_id}: Direct=${r.direct_energy.toFixed(2)} KWH, Indirect=${r.indirect_energy.toFixed(2)} KWH, Total=${r.total_center_energy.toFixed(2)} KWH, Beta=${r.beta.toFixed(4)}</p>`
                ).join('');
                const downloadExcelLink = document.getElementById('download-excel');
                downloadExcelLink.href = `/download_file/${data.excel_file}`;
                downloadExcelLink.classList.remove('hidden');
                document.querySelector('#download-links button').classList.remove('hidden');
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('download-pdf-btn').disabled = false;
                updateCharts(data.jobs, data.center_energy_results);
            } catch (error) {
                alert('Error during optimization: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = 'Run Optimization';
                spinner.classList.add('hidden');
            }
        }

        function resetAll() {
            machines = [];
            jobs = [];
            centers = [];
            latestOptimizationData = null;
            updateMachineList();
            updateJobList();
            updateCenterList();
            clearInputs(['total-space', 'total-energy', 'period-hours']);
            document.getElementById('optimization-result').textContent = '';
            document.getElementById('center-energy-results').innerHTML = '';
            document.getElementById('download-links').innerHTML = `
                <a id="download-excel" href="#" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors hidden">Download Excel</a>
                <a id="download-pdf" href="#" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors hidden">Download PDF File</a>
                <button onclick="alert('View Excel functionality requires local file access. Please download and open the Excel file.')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors hidden">View Excel</button>
            `;
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('download-pdf-btn').disabled = true;
            const canvases = ['pie-chart', 'bar-chart', 'line-graph'];
            canvases.forEach(id => {
                const ctx = document.getElementById(id).getContext('2d');
                if (window[id + 'Chart']) window[id + 'Chart'].destroy();
            });
        }

        function updateChartColors() {
            const isDark = document.documentElement.classList.contains('dark');
            const color = isDark ? '#fff' : '#000';
            if (window.pieChart) {
                window.pieChart.data.datasets[0].borderColor = color;
                window.pieChart.options.plugins.legend.labels.color = color;
                window.pieChart.update();
            }
            if (window.barChart) {
                window.barChart.data.datasets[0].borderColor = color;
                window.barChart.options.plugins.legend.labels.color = color;
                window.barChart.options.scales.x.ticks.color = color;
                window.barChart.options.scales.y.ticks.color = color;
                window.barChart.update();
            }
            if (window.lineChart) {
                window.lineChart.options.plugins.legend.labels.color = color;
                window.lineChart.options.scales.x.ticks.color = color;
                window.lineChart.options.scales.y.ticks.color = color;
                window.lineChart.update();
            }
        }

        function updateCharts(jobs, center_energy_results) {
            const isDark = document.documentElement.classList.contains('dark');
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'top', 
                        labels: { 
                            color: isDark ? '#fff' : '#000',
                            font: { size: 10 }
                        } 
                    },
                    tooltip: { 
                        enabled: true,
                        titleFont: { size: 10 },
                        bodyFont: { size: 8 }
                    }
                }
            };

            if (window.pieChart) window.pieChart.destroy();
            window.pieChart = new Chart(document.getElementById('pie-chart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: jobs.map(j => j.job_name),
                    datasets: [{
                        data: jobs.map(j => j.job_cost),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'],
                        borderColor: isDark ? '#fff' : '#000',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            if (window.barChart) window.barChart.destroy();
            window.barChart = new Chart(document.getElementById('bar-chart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: jobs.map(j => j.job_name),
                    datasets: [{
                        label: 'Energy Cost',
                        data: jobs.map(j => j.job_cost),
                        backgroundColor: '#36a2eb',
                        borderColor: isDark ? '#fff' : '#000',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                color: isDark ? '#fff' : '#000',
                                font: { size: 8 }
                            } 
                        },
                        x: { 
                            ticks: { 
                                color: isDark ? '#fff' : '#000',
                                font: { size: 8 }
                            } 
                        }
                    }
                }
            });

            if (window.lineChart) window.lineChart.destroy();
            window.lineChart = new Chart(document.getElementById('line-graph').getContext('2d'), {
                type: 'line',
                data: {
                    labels: center_energy_results.map(r => `${r.center_id}_${r.machine_id}`),
                    datasets: [
                        { label: 'Direct Energy', data: center_energy_results.map(r => r.direct_energy), borderColor: '#ff6384', fill: false },
                        { label: 'Indirect Energy', data: center_energy_results.map(r => r.indirect_energy), borderColor: '#36a2eb', fill: false }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                color: isDark ? '#fff' : '#000',
                                font: { size: 8 }
                            } 
                        },
                        x: { 
                            ticks: { 
                                color: isDark ? '#fff' : '#000',
                                font: { size: 8 }
                            } 
                        }
                    }
                }
            });
        }

        async function downloadPDF() {
            if (!latestOptimizationData) {
                alert('Please run optimization first to generate a PDF.');
                return;
            }

            const downloadPdfLink = document.getElementById('download-pdf');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            downloadPdfLink.classList.add('hidden');
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.querySelector('span').textContent = 'Generating PDF...';
            try {
                const chartIds = ['pie-chart', 'bar-chart', 'line-graph'];
                const chartImages = {};
                for (const id of chartIds) {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const image = await html2canvas(canvas, { scale: 2 });
                        chartImages[id] = image.toDataURL('image/png');
                    }
                }

                const totalSpace = parseFloat(document.getElementById('total-space').value);
                const totalEnergy = parseFloat(document.getElementById('total-energy').value);
                const periodHours = parseFloat(document.getElementById('period-hours').value);

                const response = await fetch('/generate_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        machines,
                        jobs: latestOptimizationData.jobs,
                        centers,
                        total_space: totalSpace,
                        total_energy: totalEnergy,
                        period_hours: periodHours,
                        optimization_result: latestOptimizationData.optimization_result,
                        center_energy_results: latestOptimizationData.center_energy_results,
                        total_cost: latestOptimizationData.total_cost,
                        chart_images: chartImages
                    })
                });

                if (!response.ok) throw new Error('PDF generation failed: ' + response.statusText);
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                downloadPdfLink.href = `/download_file/${data.pdf_file}`;
                downloadPdfLink.classList.remove('hidden');
            } catch (error) {
                alert('Error generating PDF: ' + error.message);
            } finally {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.querySelector('span')?.remove();
                downloadPdfBtn.textContent = 'Download PDF';
            }
        }

        fetch('/api/job_templates')
            .then(res => {
                if (!res.ok) throw new Error(`Failed to fetch job templates: ${res.statusText}`);
                return res.json();
            })
            .then(data => {
                jobTemplates = data.map(entry => {
                    const key = Object.keys(entry)[0];
                    return {
                        name: entry[key]['jobs-list'][0]['job-name'],
                        data: entry[key]
                    };
                });
            })
            .catch(error => {
                console.error('Error fetching job templates:', error);
                alert('Failed to load job templates. Please try again later.');
            });

        const jobInput = document.getElementById('job-name');
        const suggestionBox = document.getElementById('job-suggestions');

        jobInput.addEventListener('input', () => {
            const query = jobInput.value.toLowerCase();
            suggestionBox.innerHTML = '';
            if (!query) return suggestionBox.classList.add('hidden');

            const matches = jobTemplates.filter(t => t.name.toLowerCase().includes(query));
            matches.forEach(t => {
                const li = document.createElement('li');
                li.textContent = t.name;
                li.className = 'px-4 py-2 hover:bg-blue-100 cursor-pointer';
                li.onclick = () => {
                    jobInput.value = t.name;
                    suggestionBox.classList.add('hidden');
                    fillFromTemplate(t.data);
                };
                suggestionBox.appendChild(li);
            });

            suggestionBox.classList.toggle('hidden', matches.length === 0);
        });

        function fillFromTemplate(template) {
            machines = template["machine-list"].map((m, i) => ({
                id: `M${i + 1}`,
                name: m["machine-name"],
                power: m["machine-power"],
                processing_time: m["machine-hours"],
                cost: m["machine-cost"]
            }));
            updateMachineList();

            jobs = template["jobs-list"].map((j, i) => ({
                id: `J${i + 1}`,
                name: j["job-name"],
                processing_time: j["job-time"],
                area: j["job-area"],
                deadline: j["job-deadline"]
            }));
            updateJobList();

            centers = template["center-list"].map(c => ({
                id: c["center-id"],
                area: c["center-area"]
            }));
            updateCenterList();

            document.getElementById('total-energy').value = template["global-parameters"]["total-energy"];
            document.getElementById('period-hours').value = template["global-parameters"]["period-hours"];
            document.getElementById('total-space').value = template["global-parameters"]["total-space"];
        }

        updateMachineList();
        updateJobList();
        updateCenterList();
    </script>
</body>
</html>